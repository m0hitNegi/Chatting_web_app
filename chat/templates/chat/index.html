{% extends 'chat/base.html' %}

{% load static %}
{% block link %}
    <link rel="stylesheet" href="{% static 'chat/css/index.css' %}">
{% endblock %}

{% block div %}
	<div class="parallax">
		<p>
            {% if user_session %}
                <span class="round-corn" id="howdy-user">Welcome {{full_name}}!</span>
            {% else %}
                <a class="btn" href="{% url 'chat:signup' %}">Getting started</a>
            {% endif %}
		</p>
    </div>
    {% if user_session %}
        <div class="text-center">
            <i class="fa fa-chevron-circle-down" id="down-button">
                <a role="button"></a>
            </i>
        </div>
        <div class="container-fluid cont-fl-custom-bg">
            <div class="row" style="height: 36em;">
                <div class="col-md-3" style="height:30em;overflow-y: auto; padding-top: 20px;">
                    <!-- <form action="" class="form-inline text-center">
                        <input type="text" class="form-control col-md-8" id="search-box" placeholder="Search a username" style="border-radius: 4px 0 0 4px;">
                        <button class="form-btn" type="submit"><strong>Search</strong></button>
                    </form> -->
                    <ul class="list-group text-center">
                        <li class="list-group-item list-group-item-success"><strong>Online</strong></li>
                    </ul>
                    <ul class="list-group text-center" id="online_users" style="overflow: auto;">
                        {% for usr in online %}
                            <li class="list-group-item list-group-item-primary"><button type="button" role="button" class="clickable-on round-corn" onclick="start_conv(this)">{{ usr }}</li>
                        {% endfor %}
                    </ul>
                </div>
               
                <div class="col-md-7 msg-box-border">
                    <div  id="user-selected" style="display:none;">
                        <div class="contact-navbar text-center round-corn">
                            <h4 id="current_name"></h4>
                        </div>
                        <div class="container">
                            <div style="height: 30em;">
                                <span id="add_new_area"></span>
                                <input type="text" class="round-corn" id="msg-input" placeholder="Enter your message here!">
                                <input type="button" name="now-message" class="form-btn" id="subm-btn" value="Send"/>
                            </div>
                        </div>
                    </div>
                    <div id="no-user-selection">
                    </div>
                </div>
                <div class="col-md-2" style="margin-top: 20px;">
                    <ul class="list-group text-center" id="new-msgs">
                        <!-- <li class="list-group-item blur-bg round-corn">
                            <a href="#" class="acnt-changes">Change your firstname</a>
                        </li>
                        <li class="list-group-item blur-bg round-corn">
                            <a href="#" class="acnt-changes">Change your lastname</a>
                        </li>
                        <li class="list-group-item blur-bg round-corn">
                            <a href="#" class="acnt-changes">Change your username</a>
                        </li>
                        <li class="list-group-item blur-bg round-corn">
                            <a href="#" class="acnt-changes">Change your phone number</a>
                        </li>
                        <li class="list-group-item blur-bg round-corn">
                            <a href="#" class="acnt-changes">Change your password</a>
                        </li> -->
                        <li class="list-group-item list-group-item-success" id="show-new" style="display: none;"><strong>New Message(s)</strong></li>
                        <li class="list-group-item list-group-item-danger" id="no-new">No new message! :(</li>
                    </ul>
                </div>
            </div>
        </div>
    {% endif %}
{% endblock %}

{% block script %}
<script type="text/javascript">
    var roomName = 'online';
    var user_online = "{{ user_session }}";
    var full_name = "{{ full_name }}";

    if (user_online) {
        var onlineSocket = new WebSocket('ws://' + window.location.host);
        document.cookie = "usrname=" + user_online;
        
        onlineSocket.onmessage = function(e) {
            var data = JSON.parse(e.data);
            var uname = data['uname'] + ' - (' + data['full_name'] + ')';
            if (data['uname']) {
                if (data['online']) {
                    var sanity_check = {uname: 1};
                    var usr_arr = [uname];

                    $('#online_users').children().each(function() {
                        usr_arr.push($(this).find('button').text());
                    });

                    $('#online_users').empty();
                    for(var i = 0; i < usr_arr.length; i++) {
                        if(sanity_check[usr_arr[i]]) continue;
                        sanity_check[usr_arr[i]] = 1;

                        $('#online_users').append($('<li>').attr(
                            'class', 'list-group-item list-group-item-primary'
                            ).append($('<button>').attr({
                                    type: 'button',
                                    class: 'clickable-on round-corn',
                                    role: 'button',
                                    onclick: 'start_conv(this)'
                                }).text(usr_arr[i])
                            )
                        );
                    }
                }
                else {
                    var sanity_check = {};
                    var usr_arr = [];

                    $('#online_users').children().each(function() {
                        var __a = $(this).find('button').text();
                        if(uname != __a) usr_arr.push(__a);
                    });

                    $('#online_users').empty();
                    for(var i = 0; i < usr_arr.length; i++) {
                        if(sanity_check[usr_arr[i]]) continue;
                        sanity_check[usr_arr[i]] = 1;

                        $('#online_users').append($('<li>').attr(
                            'class', 'list-group-item list-group-item-primary'
                            ).append($('<button>').attr({
                                    type: 'button',
                                    class: 'clickable-on round-corn',
                                    role: 'button',
                                    onclick: 'start_conv(this)'
                                }).text(usr_arr[i])
                            )
                        );
                    }
                }
            }
            else {
                var msg_from = data['from'];
                var msg_to = data['to'];
                var msg = data['txt_msg'];

                if (document.cookie.split('=')[2] === msg_to) {
                    var chat_area = document.querySelector('#' + msg_from);
                    if(!chat_area) {
                        $('#add_new_area').append($('<textarea>').attr({
                                id: msg_from,
                                class: 'text-msg round-corn',
                                disabled: true
                            })
                        );
                        chat_area = document.querySelector('#' + msg_from);
                    }

                    chat_area.value += msg_from + ': ';
                    chat_area.value += msg + '\n\n';
                    chat_area.scrollTop = chat_area.scrollHeight;

                    if (!$('#' + msg_from).is(':visible')) {
                        if (!document.querySelector('#msgfrom-' + msg_from)) {
                            $('#no-new').hide();
                            $('#show-new').show();
                            $('#new-msgs').append(
                                $('<li>').append(
                                    $('<button>').attr({
                                        id: 'msgfrom-' + msg_from,
                                        type: 'button',
                                        class: 'clickable-on round-corn',
                                        role: 'button',
                                        onclick: 'start_conv(this)'
                                    }).text(msg_from)
                                ).attr('class', 'list-group-item')
                            );
                        }
                    }
                }
            }
        };

        onlineSocket.onopen = function(e) {
            onlineSocket.send(JSON.stringify({
                'user_online' : user_online,
                'full_name' : full_name
            }));
        }

        onlineSocket.onclose = function(e) {
            alert('Something went wrong. Please refresh the page!');
            console.error('Achanak band ho gya bhai!!!');
        };

        document.querySelector('#msg-input').onkeyup = function(key) {
            if (key.keyCode === 13) {
                document.querySelector('#subm-btn').click();
            }
        };

        document.querySelector('#subm-btn').onclick = function(data) {
            var to = document.querySelector('#current_name').innerHTML;
            var text = document.querySelector('#msg-input');
            var chat_area = document.querySelector('#' + to);
            if (text.value.trim()) {
                chat_area.value += 'You: ';
                chat_area.value += text.value + '\n\n';
                onlineSocket.send(JSON.stringify({
                    'from': user_online,
                    'to': to,
                    'text': text.value
                }));
            }
            text.value = '';
            chat_area.scrollTop = chat_area.scrollHeight;
        }

        function start_conv(e) {
            var name = $(e).text().split(' ')[0];
            if(document.querySelector('#' + name)) {
                $('.text-msg').hide();
                $('#' + name).show();
            }
            else {
                $('.text-msg').hide();
                $('#add_new_area').append(
                    $('<textarea>').attr({
                        id: name,
                        class: 'text-msg round-corn',
                        disabled: true
                    })).show();
            }

            $('#current_name').text(name);
            $('#user-selected').show();
            $('#msg-input').focus();
            $('#no-user-selection').hide();
            $('#msgfrom-' + name).parent().remove();
            if($('#new-msgs').children().length < 3) {
                $('#show-new').hide();
                $('#no-new').show();
            }
        }
    }

</script>
{% endblock %}